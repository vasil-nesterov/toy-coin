#!/usr/bin/env ruby
# typed: strict

require_relative '../config/boot'

if ARGV.size != 1 || !ARGV[0].is_integer?
  puts "Usage: #{$PROGRAM_NAME} <complexity>"
  exit 1
end

if File.exist?(BLOCKCHAIN_FILE_PATH)
  puts "#{BLOCKCHAIN_FILE_PATH}: File already exists\n" 
  exit 1
end

chain_tweaks = {
  block_version: Block::CURRENT_VERSION,
  complexity: ARGV[0].to_i
}

blockchain = Blockchain.new
miner = Miner.new(blockchain: blockchain, mempool: Mempool.new)
# TODO: Save coinbase signing key somewhere
genesis_block, coinbase_signing_key = miner.next_block(chain_tweaks:)

blockchain.add_block(genesis_block)

BlockchainStorage.new(BLOCKCHAIN_FILE_PATH).save(blockchain)
